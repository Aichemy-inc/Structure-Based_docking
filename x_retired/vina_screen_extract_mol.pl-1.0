#!/usr/bin/perl -w
use strict;

############################################################################
#
#	Peter M.U. Ung	@ MSSM
#
#	v1.0	- 13.10.24
#
#	Extract the structure/SMILES of AutoDock .pdbqt result with the 
#	correpsonding ZINC ID.
#	Takes the Top list generated by vina_screen_get_top.py
#	Uses OBabel for conversion.
#	Handles .smi, .mol2, .sdf, .mol format.
#
#	Required:	vina_screen_preprocess.py
#			vina_screen_get_top.py
#
############################################################################


die "\n    Usage: x.pl [dir with ZINC txt] [top result] [output format] [result]\n\n"
  unless @ARGV == 4;

my @file = `ls $ARGV[0]/*.txt`;
die "\n    Warning: ZINC reference files are zipped\n\n"
  if !@file;

## Read in the reference files with ZINC ID
my %zinc;
foreach my $file (@file) {

  open ZINC, "< $file";
  while (<ZINC>) {
    chomp;
    my @line = split;
    my $ZINC = $line[2];
    my @mol  = split /\./, $line[0];
    my $ADid = $mol[0].".".$mol[1].".".$mol[3];

    $zinc{$ADid} = $ZINC;
  }
  print "\n  ## Finished loading $file\n\n";
  close ZINC;
}

## Read in the Top_Vina list
my @data = ();
open IN, "< $ARGV[1]";
while (<IN>) {
  next if /##/;
  last if /^\n/;
  my @line = split;
  my @fold = split /\//, $line[1];
  my @ADid = split /\./, $fold[1];

  my $id   = $fold[0].".".$ADid[2];
             # (rank,     location, folder,   ADid,     ZINC      )
  push @data, [($line[0], $line[1], $fold[0], $ADid[2], $zinc{$id})];
}
close IN;

## 
my $i = 1;
open OUT, "> $ARGV[3]";
foreach my $data (@data) {
  ## Output Top_Vina as SMILES file
  if ($ARGV[2] eq "smi") {
    my @smi = `obabel -ipdbqt $ARGV[0]$data->[1] -o$ARGV[2] --canonical -l 1`;
    my @check = split /\t/, $smi[0];

#    die "\n $check[1] != $data->[2].$data->[3]\n\n" if $check[1] !~ /$data->[2]\.$data->[3]/;
#    $smi[0] =~ s/\.pdbqt/ $data->[4]/;
    print OUT "$smi[0]\t$data->[4]\t_$data->[0]";
  }
  ## Output Top_Vina as 3D file
  if ($ARGV[2] =~ /mol2|mol|sdf/) {
    my @str = `obabel -ipdbqt $ARGV[0]/$data->[1] -o$ARGV[2] -c -l 1`;
    foreach (@str) {
      $_ = "$data->[4]\n_$data->[0]\n" if /\.pdbqt/;
      print OUT;
    }
  }
  print "$i  - "; $i++;
}
